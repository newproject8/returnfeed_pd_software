<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReturnFeed PD Software</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 580px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.2rem;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card h2 {
            color: #5a67d8;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #5a67d8;
        }

        .btn {
            background: linear-gradient(135deg, #5a67d8, #667eea);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(90, 103, 216, 0.3);
        }

        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn.secondary:hover {
            background: #cbd5e0;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
            text-align: center;
        }

        .status.connected {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.disconnected {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.connecting {
            background: #fefcbf;
            color: #744210;
            border: 1px solid #f6e05e;
        }

        .tally-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .tally-box {
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .tally-program {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #fc8181;
        }

        .tally-program.active {
            background: #f56565;
            color: white;
            animation: pulse 1s infinite;
        }

        .tally-preview {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #9ae6b4;
        }

        .tally-preview.active {
            background: #48bb78;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .inputs-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .input-item {
            padding: 8px;
            margin-bottom: 5px;
            background: #f7fafc;
            border-radius: 4px;
            font-size: 13px;
        }

        .input-item.active {
            background: #bee3f8;
            border-left: 4px solid #3182ce;
        }

        .log-area {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ReturnFeed PD</h1>
            <p>vMix íƒˆë¦¬ ì‹œìŠ¤í…œ ì—°ë™ ì†Œí”„íŠ¸ì›¨ì–´</p>
        </div>

        <!-- vMix ì—°ê²° ì„¤ì • -->
        <div class="card">
            <h2>ğŸ¥ vMix ì—°ê²°</h2>
            <div id="vmix-status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
            
            <div class="form-group">
                <label for="vmix-host">vMix IP ì£¼ì†Œ:</label>
                <input type="text" id="vmix-host" value="127.0.0.1" placeholder="ì˜ˆ: 192.168.1.100">
            </div>
            
            <div class="form-group">
                <label for="vmix-port">vMix TCP í¬íŠ¸:</label>
                <input type="number" id="vmix-port" value="8099" placeholder="8099">
            </div>
            
            <button id="connect-vmix" class="btn">vMix ì—°ê²°</button>
            <button id="disconnect-vmix" class="btn secondary" disabled>ì—°ê²° í•´ì œ</button>
        </div>

        <!-- ë¦´ë ˆì´ ì„œë²„ ì„¤ì • -->
        <div class="card">
            <h2>ğŸŒ RelayRelay ì„œë²„ ì—°ê²°</h2>
            <div id="relay-status" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
            
            <div class="form-group">
                <label for="relay-url">ë¦´ë ˆì´ ì„œë²„ URL:</label>
                <input type="text" id="relay-url" value="wss://returnfeed.net/ws" placeholder="wss://returnfeed.net/ws">
            </div>
            
            <div class="form-group">
                <label for="session-id">ì„¸ì…˜ ID:</label>
                <input type="text" id="session-id" placeholder="ì˜ˆ: pd_550e8400...">
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="auto-connect" checked>
                <label for="auto-connect">ì‹œì‘ ì‹œ ìë™ ì—°ê²°</label>
            </div>
            
            <button id="connect-relay" class="btn">ë¦´ë ˆì´ ì—°ê²°</button>
            <button id="disconnect-relay" class="btn secondary" disabled>ì—°ê²° í•´ì œ</button>
        </div>

        <!-- íƒˆë¦¬ ìƒíƒœ í‘œì‹œ -->
        <div class="card">
            <h2>ğŸ“º íƒˆë¦¬ ìƒíƒœ</h2>
            <div class="tally-display">
                <div id="tally-program" class="tally-box tally-program">
                    PROGRAM<br>
                    <span id="program-input">-</span>
                </div>
                <div id="tally-preview" class="tally-box tally-preview">
                    PREVIEW<br>
                    <span id="preview-input">-</span>
                </div>
            </div>
        </div>

        <!-- ì¹´ë©”ë¼ ì…ë ¥ ëª©ë¡ -->
        <div class="card">
            <h2>ğŸ¬ ì¹´ë©”ë¼ ì…ë ¥</h2>
            <div>ì´ <span id="inputs-count">0</span>ê°œ ì¹´ë©”ë¼</div>
            <div id="inputs-list" class="inputs-list">
                <div class="input-item">ì¹´ë©”ë¼ë¥¼ ì°¾ëŠ” ì¤‘...</div>
            </div>
        </div>

        <!-- ë¡œê·¸ -->
        <div class="card">
            <h2>ğŸ“ ë¡œê·¸</h2>
            <div id="log-area" class="log-area"></div>
            <button id="clear-log" class="btn secondary" style="margin-top: 10px;">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script>
        // ìƒíƒœ ë³€ìˆ˜
        let vmixConnected = false;
        let relayConnected = false;
        let currentTally = { program: null, preview: null };
        let currentInputs = {};

        // DOM ìš”ì†Œ
        const elements = {
            vmixStatus: document.getElementById('vmix-status'),
            relayStatus: document.getElementById('relay-status'),
            vmixHost: document.getElementById('vmix-host'),
            vmixPort: document.getElementById('vmix-port'),
            relayUrl: document.getElementById('relay-url'),
            sessionId: document.getElementById('session-id'),
            autoConnect: document.getElementById('auto-connect'),
            connectVmix: document.getElementById('connect-vmix'),
            disconnectVmix: document.getElementById('disconnect-vmix'),
            connectRelay: document.getElementById('connect-relay'),
            disconnectRelay: document.getElementById('disconnect-relay'),
            programInput: document.getElementById('program-input'),
            previewInput: document.getElementById('preview-input'),
            tallyProgram: document.getElementById('tally-program'),
            tallyPreview: document.getElementById('tally-preview'),
            inputsList: document.getElementById('inputs-list'),
            inputsCount: document.getElementById('inputs-count'),
            logArea: document.getElementById('log-area'),
            clearLog: document.getElementById('clear-log')
        };

        // ë¡œê·¸ í•¨ìˆ˜
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            elements.logArea.textContent += `[${timestamp}] ${message}\n`;
            elements.logArea.scrollTop = elements.logArea.scrollHeight;
            window.electronAPI.log(message);
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateVmixStatus(connected, message = null) {
            vmixConnected = connected;
            elements.vmixStatus.textContent = connected ? 'ì—°ê²°ë¨' : (message || 'ì—°ê²° ì•ˆë¨');
            elements.vmixStatus.className = `status ${connected ? 'connected' : 'disconnected'}`;
            elements.connectVmix.disabled = connected;
            elements.disconnectVmix.disabled = !connected;
        }

        function updateRelayStatus(connected, message = null) {
            relayConnected = connected;
            elements.relayStatus.textContent = connected ? 'ì—°ê²°ë¨' : (message || 'ì—°ê²° ì•ˆë¨');
            elements.relayStatus.className = `status ${connected ? 'connected' : 'disconnected'}`;
            elements.connectRelay.disabled = connected;
            elements.disconnectRelay.disabled = !connected;
        }

        function updateTallyDisplay(tallyData) {
            currentTally = tallyData;
            
            // Program ìƒíƒœ ì—…ë°ì´íŠ¸
            elements.programInput.textContent = tallyData.program || '-';
            elements.tallyProgram.classList.toggle('active', !!tallyData.program);
            
            // Preview ìƒíƒœ ì—…ë°ì´íŠ¸
            elements.previewInput.textContent = tallyData.preview || '-';
            elements.tallyPreview.classList.toggle('active', !!tallyData.preview);
            
            log(`Tally: PGM=${tallyData.program || 'OFF'}, PVW=${tallyData.preview || 'OFF'}`);
        }

        function updateInputsList(inputsData) {
            currentInputs = inputsData.inputs || {};
            const inputCount = Object.keys(currentInputs).length;
            
            elements.inputsCount.textContent = inputCount;
            
            if (inputCount === 0) {
                elements.inputsList.innerHTML = '<div class="input-item">ì¹´ë©”ë¼ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>';
                return;
            }
            
            elements.inputsList.innerHTML = '';
            
            Object.entries(currentInputs).forEach(([number, input]) => {
                const div = document.createElement('div');
                div.className = 'input-item';
                if (input.state === 'Running') {
                    div.classList.add('active');
                }
                
                div.innerHTML = `
                    <strong>Input ${number}:</strong> ${input.title || input.name || 'Unknown'}
                    <br><small>${input.type || 'Video'} - ${input.state || 'Paused'}</small>
                `;
                
                elements.inputsList.appendChild(div);
            });
            
            log(`ì¹´ë©”ë¼ ì…ë ¥ ì—…ë°ì´íŠ¸: ${inputCount}ê°œ`);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        elements.connectVmix.addEventListener('click', async () => {
            const host = elements.vmixHost.value.trim();
            const port = parseInt(elements.vmixPort.value);
            
            if (!host || !port) {
                alert('vMix IP ì£¼ì†Œì™€ í¬íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            updateVmixStatus(false, 'ì—°ê²° ì¤‘...');
            elements.vmixStatus.className = 'status connecting';
            
            try {
                const result = await window.electronAPI.connectVmix({ host, port });
                if (result.success) {
                    updateVmixStatus(true);
                    log(`vMix ì—°ê²° ì„±ê³µ: ${host}:${port}`);
                } else {
                    updateVmixStatus(false, result.error || 'ì—°ê²° ì‹¤íŒ¨');
                    log(`vMix ì—°ê²° ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                updateVmixStatus(false, 'ì—°ê²° ì˜¤ë¥˜');
                log(`vMix ì—°ê²° ì˜¤ë¥˜: ${error.message}`);
            }
        });

        elements.disconnectVmix.addEventListener('click', async () => {
            try {
                await window.electronAPI.disconnectVmix();
                updateVmixStatus(false);
                log('vMix ì—°ê²° í•´ì œ');
            } catch (error) {
                log(`vMix ì—°ê²° í•´ì œ ì˜¤ë¥˜: ${error.message}`);
            }
        });

        elements.connectRelay.addEventListener('click', async () => {
            const url = elements.relayUrl.value.trim();
            const sessionId = elements.sessionId.value.trim();
            
            if (!url || !sessionId) {
                alert('ë¦´ë ˆì´ ì„œë²„ URLê³¼ ì„¸ì…˜ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            updateRelayStatus(false, 'ì—°ê²° ì¤‘...');
            elements.relayStatus.className = 'status connecting';
            
            try {
                const result = await window.electronAPI.connectRelay({ url, sessionId });
                if (result.success) {
                    updateRelayStatus(true);
                    log(`ë¦´ë ˆì´ ì—°ê²° ì„±ê³µ: ${sessionId}`);
                } else {
                    updateRelayStatus(false, result.error || 'ì—°ê²° ì‹¤íŒ¨');
                    log(`ë¦´ë ˆì´ ì—°ê²° ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                updateRelayStatus(false, 'ì—°ê²° ì˜¤ë¥˜');
                log(`ë¦´ë ˆì´ ì—°ê²° ì˜¤ë¥˜: ${error.message}`);
            }
        });

        elements.disconnectRelay.addEventListener('click', async () => {
            try {
                await window.electronAPI.disconnectRelay();
                updateRelayStatus(false);
                log('ë¦´ë ˆì´ ì—°ê²° í•´ì œ');
            } catch (error) {
                log(`ë¦´ë ˆì´ ì—°ê²° í•´ì œ ì˜¤ë¥˜: ${error.message}`);
            }
        });

        elements.clearLog.addEventListener('click', () => {
            elements.logArea.textContent = '';
        });

        // Electron API ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.electronAPI.onSettingsLoaded((event, settings) => {
            elements.vmixHost.value = settings.vmixHost || '127.0.0.1';
            elements.vmixPort.value = settings.vmixPort || 8099;
            elements.relayUrl.value = settings.relayUrl || 'wss://returnfeed.net/ws';
            elements.sessionId.value = settings.sessionId || '';
            elements.autoConnect.checked = settings.autoConnect || false;
            
            log('ì„¤ì • ë¡œë“œ ì™„ë£Œ');
        });

        window.electronAPI.onTallyData((event, tallyData) => {
            updateTallyDisplay(tallyData);
        });

        window.electronAPI.onInputsData((event, inputsData) => {
            updateInputsList(inputsData);
        });

        window.electronAPI.onVmixError((event, error) => {
            log(`vMix ì˜¤ë¥˜: ${error}`);
            updateVmixStatus(false, 'ì˜¤ë¥˜ ë°œìƒ');
        });

        window.electronAPI.onVmixDisconnected(() => {
            log('vMix ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
            updateVmixStatus(false, 'ì—°ê²° ëŠì–´ì§');
        });

        window.electronAPI.onRelayConnected(() => {
            log('ë¦´ë ˆì´ ì„œë²„ ì—°ê²°ë¨');
            updateRelayStatus(true);
        });

        window.electronAPI.onRelayError((event, error) => {
            log(`ë¦´ë ˆì´ ì˜¤ë¥˜: ${error}`);
            updateRelayStatus(false, 'ì˜¤ë¥˜ ë°œìƒ');
        });

        window.electronAPI.onRelayDisconnected(() => {
            log('ë¦´ë ˆì´ ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
            updateRelayStatus(false, 'ì—°ê²° ëŠì–´ì§');
        });

        // ì„¤ì • ì €ì¥
        function saveSettings() {
            const settings = {
                vmixHost: elements.vmixHost.value,
                vmixPort: parseInt(elements.vmixPort.value),
                relayUrl: elements.relayUrl.value,
                sessionId: elements.sessionId.value,
                autoConnect: elements.autoConnect.checked
            };
            
            window.electronAPI.saveSettings(settings);
        }

        // ì„¤ì • ë³€ê²½ ì‹œ ìë™ ì €ì¥
        [elements.vmixHost, elements.vmixPort, elements.relayUrl, elements.sessionId, elements.autoConnect]
            .forEach(element => {
                element.addEventListener('change', saveSettings);
            });

        // ì´ˆê¸°í™”
        log('ReturnFeed PD Software ì‹œì‘');
        log('vMixì™€ ë¦´ë ˆì´ ì„œë²„ ì„¤ì •ì„ í™•ì¸í•˜ê³  ì—°ê²°í•˜ì„¸ìš”');
    </script>
</body>
</html>