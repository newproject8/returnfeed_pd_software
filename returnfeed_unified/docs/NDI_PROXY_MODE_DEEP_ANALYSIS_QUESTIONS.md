# NDI 프록시 모드 40fps 병목 현상 - 상위 AI 컨설팅 질문서

## 현재 상황 요약

### 증상
- **프록시 모드**: 40fps대 고정 (최적화 후에도 개선 없음)
- **일반 모드**: 60fps 정상 작동
- **이전 기록**: 프록시 모드에서 56fps 달성 이력 있음

### 이미 시도한 최적화
1. 디버그 코드 제거 (hot path)
2. QImage 이중 복사 제거
3. NumPy 배열 복사 최적화 (ascontiguousarray)
4. 불필요한 로깅 감소

## 심층 분석이 필요한 영역

### 1. NDI SDK 내부 동작 메커니즘

**질문 1.1: 프록시 모드의 근본적인 차이점**
- NDI SDK에서 `RECV_BANDWIDTH_LOWEST`가 정확히 어떤 방식으로 작동하는가?
- 프록시 모드가 일반 모드와 다른 코덱이나 압축 알고리즘을 사용하는가?
- SDK 내부에서 프레임 버퍼링이나 큐잉 전략이 다른가?

**질문 1.2: recv_capture_v2 타임아웃 동작**
```python
frame_type, v_frame, a_frame, m_frame = ndi.recv_capture_v2(self.receiver, timeout_ms)
```
- 20ms 타임아웃 설정 시, 실제로 프레임이 없을 때 20ms를 전부 기다리는가?
- 아니면 프레임이 준비되면 즉시 반환하는가?
- 프록시 모드에서 타임아웃 동작이 다르게 작동할 가능성은?

**질문 1.3: 프레임 타이밍과 동기화**
- NDI 송신측에서 프록시 모드일 때 프레임 전송 패턴이 다른가?
- 버스트 전송 vs 균등 전송?
- 프레임 타임스탬프 처리 방식의 차이?

### 2. 네트워크 및 전송 프로토콜

**질문 2.1: 전송 프로토콜 차이**
- 프록시 모드가 TCP를 사용하고 일반 모드가 UDP를 사용하는가?
- 또는 둘 다 TCP/UDP를 사용하지만 패킷 크기나 전송 패턴이 다른가?
- Nagle 알고리즘이나 TCP_NODELAY 설정의 영향?

**질문 2.2: 네트워크 버퍼와 수신 윈도우**
- 프록시 모드에서 더 작은 수신 버퍼를 사용하는가?
- 네트워크 스택에서 패킷 병합이나 지연이 발생하는가?
- SO_RCVBUF 크기 조정이 도움이 될까?

### 3. 시스템 레벨 병목

**질문 3.1: CPU 스케줄링과 스레드 우선순위**
- NDI 수신 스레드의 우선순위가 적절한가?
- 프록시 모드에서 컨텍스트 스위칭이 더 자주 발생하는가?
- CPU 코어 친화성(affinity) 설정이 필요한가?

**질문 3.2: 메모리 접근 패턴**
- 프록시 모드의 작은 프레임이 캐시 효율성에 영향을 주는가?
- False sharing이나 캐시 라인 바운싱 문제?
- NUMA 아키텍처에서의 메모리 접근 최적화?

### 4. 프로파일링 및 측정 전략

**질문 4.1: 병목 지점 정확한 파악**
- `recv_capture_v2` 호출에서 실제로 얼마나 시간이 소요되는가?
- 프레임이 도착했을 때와 타임아웃됐을 때의 시간 차이?
- perf, VTune, 또는 NDI 전용 프로파일링 도구 사용?

**질문 4.2: 네트워크 레벨 모니터링**
```bash
# Wireshark나 tcpdump로 패킷 패턴 분석
# 프록시 모드와 일반 모드의 패킷 간격, 크기, 프로토콜 비교
```

### 5. 아키텍처적 대안

**질문 5.1: 비동기 수신 모델**
- 폴링 방식 대신 콜백 기반 수신이 가능한가?
- 여러 수신 스레드를 사용하여 파이프라이닝?
- io_uring이나 IOCP 같은 고성능 I/O 모델 적용?

**질문 5.2: 프레임 프리페칭과 예측**
- 다음 프레임을 미리 요청하는 방식?
- 이중 버퍼링이나 트리플 버퍼링 전략?
- 프레임 도착 시간 예측 알고리즘?

### 6. NDI 환경 및 설정

**질문 6.1: NDI 설정 최적화**
- NDI 레지스트리 설정이나 환경 변수로 조정 가능한 파라미터?
- `NDI_RECV_THREAD_PRIORITY` 같은 숨겨진 설정?
- MTU 크기나 점보 프레임 설정의 영향?

**질문 6.2: 송신측 설정의 영향**
- 송신측에서 프록시 모드 최적화 옵션?
- 키프레임 간격이나 GOP 설정?
- 비트레이트 제어 방식?

## 실험 및 검증 방법

### 1. 타이밍 정밀 측정
```python
# recv_capture_v2 전후 고정밀 타이머로 측정
# 프레임 있을 때 vs 없을 때 시간 분포 분석
```

### 2. 시스템 리소스 모니터링
- CPU 사용률 및 코어별 분포
- 메모리 대역폭 사용량
- 네트워크 인터럽트 빈도

### 3. A/B 테스트
- 동일 네트워크에서 프록시/일반 모드 동시 실행
- 패킷 캡처로 전송 패턴 비교
- 지연 시간 및 지터 측정

## 추가 고려사항

### 1. 플랫폼별 차이
- Windows/Linux/macOS에서 동작 차이?
- WSL2 환경의 특수성? (사용자가 WSL2 사용 중)

### 2. NDI 버전 및 호환성
- NDI SDK 버전별 프록시 모드 성능 차이?
- NDI|HX와 일반 프록시 모드의 차이?

### 3. 하드웨어 가속
- GPU 디코딩 활용 가능성?
- SIMD 명령어 최적화?

## 핵심 질문 요약

1. **왜 프록시 모드만 40fps로 제한되는가?**
2. **NDI SDK 내부에서 프록시 모드가 다르게 처리되는 부분은?**
3. **네트워크 레벨에서 관찰 가능한 차이점은?**
4. **시스템 레벨 최적화로 개선 가능한가?**
5. **아키텍처 변경 없이 해결 가능한가?**

## 기대하는 답변

- 프록시 모드 40fps 제한의 근본 원인
- 구체적인 해결 방안 또는 우회 방법
- 추가 프로파일링이 필요한 영역
- NDI SDK 레벨에서 확인해야 할 사항